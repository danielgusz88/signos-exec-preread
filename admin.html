<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Signos Offsite Pre-Read</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        /* Admin-specific styles */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
        }
        
        .admin-header h1 {
            font-size: 24px;
        }
        
        .admin-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        .btn-primary:hover, .btn-secondary:hover {
            opacity: 0.9;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 16px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 1px solid var(--border-color);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        
        .stat-card.agree .stat-value { color: var(--accent-success); }
        .stat-card.question .stat-value { color: var(--accent-primary); }
        .stat-card.concern .stat-value { color: var(--accent-warning); }
        .stat-card.idea .stat-value { color: var(--accent-secondary); }
        
        /* AI Summary Section */
        .ai-summary-section {
            background: linear-gradient(135deg, rgba(167, 139, 250, 0.1), rgba(96, 165, 250, 0.1));
            border: 2px solid var(--accent-secondary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
        }
        
        .ai-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .ai-header h2 {
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .ai-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            min-height: 200px;
        }
        
        .ai-placeholder {
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }
        
        .ai-result {
            font-size: 14px;
            line-height: 1.8;
            color: var(--text-secondary);
        }
        
        .ai-result h3 {
            font-size: 16px;
            color: var(--text-primary);
            margin: 20px 0 10px;
        }
        
        .ai-result h3:first-child {
            margin-top: 0;
        }
        
        .ai-result ul {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .ai-result li {
            margin: 6px 0;
        }
        
        /* Section Tabs */
        .section-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        
        .section-tab {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .section-tab:hover {
            border-color: var(--accent-primary);
        }
        
        .section-tab.active {
            background: var(--accent-primary);
            color: var(--bg-primary);
            border-color: var(--accent-primary);
        }
        
        .section-tab .count {
            background: rgba(255,255,255,0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            margin-left: 6px;
        }
        
        /* Annotations List */
        .annotations-container {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid var(--border-color);
        }
        
        .annotations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .filter-group {
            display: flex;
            gap: 8px;
        }
        
        .filter-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-muted);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
        }
        
        .filter-btn.active {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .annotation-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .admin-annotation {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid var(--border-color);
        }
        
        .admin-annotation.agree { border-left-color: var(--accent-success); }
        .admin-annotation.question { border-left-color: var(--accent-primary); }
        .admin-annotation.concern { border-left-color: var(--accent-warning); }
        .admin-annotation.idea { border-left-color: var(--accent-secondary); }
        
        .annotation-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }
        
        .annotation-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .exec-avatar {
            width: 36px;
            height: 36px;
            background: var(--accent-primary);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            color: var(--bg-primary);
        }
        
        .annotation-details h4 {
            font-size: 15px;
            margin-bottom: 2px;
        }
        
        .annotation-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .annotation-badge {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 6px;
        }
        
        .annotation-badge.agree { background: rgba(52, 211, 153, 0.2); color: var(--accent-success); }
        .annotation-badge.question { background: rgba(96, 165, 250, 0.2); color: var(--accent-primary); }
        .annotation-badge.concern { background: rgba(251, 191, 36, 0.2); color: var(--accent-warning); }
        .annotation-badge.idea { background: rgba(167, 139, 250, 0.2); color: var(--accent-secondary); }
        
        .annotation-comment {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-secondary);
        }
        
        .no-annotations {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-muted);
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Executive Breakdown */
        .exec-breakdown {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        
        .exec-card {
            background: var(--bg-secondary);
            border-radius: 10px;
            padding: 16px;
            text-align: center;
        }
        
        .exec-card h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }
        
        .exec-card .count {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
        }
        
        .exec-card .status {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }
        
        .exec-card .status.complete {
            color: var(--accent-success);
        }
        
        /* General Feedback Summary */
        .general-feedback-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .feedback-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }
        
        .feedback-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .feedback-card-header .exec-avatar {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            color: var(--bg-primary);
        }
        
        .feedback-card-header h4 {
            font-size: 16px;
        }
        
        .feedback-card-header .timestamp {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .feedback-item {
            margin-bottom: 14px;
        }
        
        .feedback-item:last-child {
            margin-bottom: 0;
        }
        
        .feedback-item-label {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .feedback-item-content {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 8px;
        }
        
        .feedback-item-content:empty::before {
            content: "(No response)";
            color: var(--text-muted);
            font-style: italic;
        }
        
        .no-feedback {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            grid-column: 1 / -1;
        }
        
        /* Decision Summary Styles */
        .decision-summary-section {
            margin-bottom: 32px;
        }
        
        .decision-summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
        }
        
        .decision-summary-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .decision-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--accent-warning), var(--accent-primary));
            border-radius: 16px 16px 0 0;
        }
        
        .decision-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .decision-summary-header h4 {
            font-size: 15px;
            margin: 0;
        }
        
        .decision-number-badge {
            width: 28px;
            height: 28px;
            background: var(--accent-warning);
            color: var(--bg-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
        }
        
        .vote-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .vote-option {
            background: var(--bg-secondary);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 12px;
        }
        
        .vote-option .count {
            color: var(--accent-primary);
            font-weight: 700;
            margin-left: 4px;
        }
        
        .vote-option.leading {
            background: rgba(96, 165, 250, 0.2);
            border: 1px solid var(--accent-primary);
        }
        
        .decision-inputs-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .decision-input-item {
            background: var(--bg-secondary);
            padding: 10px 12px;
            border-radius: 8px;
        }
        
        .decision-input-item .exec-name {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 4px;
        }
        
        .decision-input-item .input-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .no-decisions {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-color);
            grid-column: 1 / -1;
        }
        
        /* Team Roster Admin Styles */
        .team-roster-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }
        
        .pod-summary-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }
        
        .pod-summary-card h4 {
            font-size: 14px;
            color: var(--accent-primary);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .pod-member-item {
            font-size: 12px;
            padding: 4px 0;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .pod-member-item .vote-count {
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="admin-header">
            <div>
                <h1>üîê Admin Dashboard</h1>
                <p class="subtitle">View and synthesize all executive feedback</p>
            </div>
            <div class="admin-actions">
                <a href="index.html" class="btn-secondary">‚Üê Back to Pre-Read</a>
                <button id="refreshBtn" class="btn-secondary">üîÑ Refresh</button>
                <button id="synthesizeBtn" class="btn-primary">ü§ñ Generate AI Summary</button>
            </div>
        </header>
        
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value" id="totalAnnotations">0</div>
                <div class="stat-label">Total Comments</div>
            </div>
            <div class="stat-card agree">
                <div class="stat-value" id="agreeCount">0</div>
                <div class="stat-label">‚úÖ Agree</div>
            </div>
            <div class="stat-card question">
                <div class="stat-value" id="questionCount">0</div>
                <div class="stat-label">‚ùì Questions</div>
            </div>
            <div class="stat-card concern">
                <div class="stat-value" id="concernCount">0</div>
                <div class="stat-label">‚ö†Ô∏è Concerns</div>
            </div>
            <div class="stat-card idea">
                <div class="stat-value" id="ideaCount">0</div>
                <div class="stat-label">üí° Ideas</div>
            </div>
        </div>
        
        <!-- Executive Breakdown -->
        <h3 style="margin-bottom: 16px;">Executive Participation</h3>
        <div class="exec-breakdown" id="execBreakdown">
            <!-- Generated by JS -->
        </div>
        
        <!-- General Feedback Section -->
        <h3 style="margin-bottom: 16px; margin-top: 24px;">üìù General Feedback from Executives</h3>
        <div class="general-feedback-summary" id="generalFeedbackSummary" style="margin-bottom: 32px;">
            <div class="loading">
                <div class="spinner"></div>
                Loading general feedback...
            </div>
        </div>
        
        <!-- Decision Summary Section -->
        <h3 style="margin-bottom: 16px; margin-top: 24px;">üéØ Decision Inputs from Executives</h3>
        <div class="decision-summary-grid" id="decisionSummaryGrid" style="margin-bottom: 32px;">
            <div class="loading">
                <div class="spinner"></div>
                Loading decision inputs...
            </div>
        </div>
        
        <!-- Team Roster Section -->
        <h3 style="margin-bottom: 16px; margin-top: 24px;">üë• Team Roster & Pod Assignments</h3>
        <div class="team-roster-summary" id="teamRosterSummary" style="margin-bottom: 32px;">
            <div class="loading">
                <div class="spinner"></div>
                Loading team assignments...
            </div>
        </div>
        
        <!-- AI Summary Section -->
        <div class="ai-summary-section">
            <div class="ai-header">
                <h2>ü§ñ AI-Powered Summary</h2>
                <span id="aiStatus" style="font-size: 13px; color: var(--text-muted);">Click "Generate AI Summary" to analyze feedback</span>
            </div>
            <div class="ai-content" id="aiContent">
                <div class="ai-placeholder">
                    <p>No summary generated yet.</p>
                    <p style="font-size: 13px; margin-top: 8px;">The AI will analyze all annotations and provide:</p>
                    <ul style="text-align: left; display: inline-block; font-size: 13px; margin-top: 12px;">
                        <li>Key themes across all feedback</li>
                        <li>Areas of consensus</li>
                        <li>Areas of friction or disagreement</li>
                        <li>Recommended discussion topics for the offsite</li>
                        <li>Open questions that need resolution</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Section Tabs -->
        <div class="section-tabs" id="sectionTabs">
            <button class="section-tab active" data-section="all">All Sections</button>
            <!-- Generated by JS -->
        </div>
        
        <!-- Annotations List -->
        <div class="annotations-container">
            <div class="annotations-header">
                <h3>All Annotations</h3>
                <div class="filter-group">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="agree">‚úÖ</button>
                    <button class="filter-btn" data-filter="question">‚ùì</button>
                    <button class="filter-btn" data-filter="concern">‚ö†Ô∏è</button>
                    <button class="filter-btn" data-filter="idea">üí°</button>
                </div>
            </div>
            <div class="annotation-list" id="annotationList">
                <div class="loading">
                    <div class="spinner"></div>
                    Loading annotations...
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="toast"></div>
    
    <script src="js/config.js"></script>
    <script src="js/supabase-client.js"></script>
    <script>
        // Admin Dashboard Logic
        let allAnnotations = [];
        let currentSectionFilter = 'all';
        let currentReactionFilter = 'all';
        
        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for store to initialize
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Generate section tabs
            generateSectionTabs();
            
            // Load data
            await loadAllData();
            
            // Setup event listeners
            setupEventListeners();
        });
        
        function generateSectionTabs() {
            const tabs = document.getElementById('sectionTabs');
            CONFIG.SECTIONS.forEach(section => {
                const tab = document.createElement('button');
                tab.className = 'section-tab';
                tab.dataset.section = section.id;
                tab.innerHTML = `${section.id}. ${section.short} <span class="count" id="count-${section.id}">0</span>`;
                tabs.appendChild(tab);
            });
        }
        
        async function loadAllData() {
            try {
                allAnnotations = await window.annotationStore.getAnnotations();
                updateStats();
                updateExecBreakdown();
                renderAnnotations();
                await loadGeneralFeedback();
                await loadDecisionInputs();
                await loadTeamAssignments();
            } catch (error) {
                console.error('Error loading data:', error);
                showToast('Error loading annotations');
            }
        }
        
        async function loadGeneralFeedback() {
            const container = document.getElementById('generalFeedbackSummary');
            
            // Check if Supabase is available
            const supabaseClient = window.annotationStore?.supabase;
            if (!supabaseClient || !window.annotationStore?.useSupabase) {
                container.innerHTML = '<div class="no-feedback">General feedback requires Supabase connection. Using localStorage fallback.</div>';
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('general_feedback')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-feedback">No general feedback submitted yet.</div>';
                    return;
                }
                
                const execColors = {
                    'Sharam': '#60a5fa',
                    'Roger': '#34d399',
                    'Lindsay': '#fbbf24',
                    'Emma': '#f87171',
                    'Colin': '#a78bfa',
                    'Dan': '#ec4899'
                };
                
                container.innerHTML = data.map(fb => {
                    const color = execColors[fb.exec_name] || '#60a5fa';
                    const initial = fb.exec_name ? fb.exec_name[0].toUpperCase() : '?';
                    const timestamp = fb.updated_at ? new Date(fb.updated_at).toLocaleString() : '';
                    const feedback = fb.feedback || {};
                    
                    const feedbackItems = [
                        { label: 'üéØ Top Strategic Priorities', content: feedback.priorities },
                        { label: '‚ö†Ô∏è Biggest Risks or Concerns', content: feedback.risks },
                        { label: 'üí° Ideas or Suggestions', content: feedback.ideas },
                        { label: '‚ùì Questions for the Team', content: feedback.questions },
                        { label: 'üìã Other Thoughts', content: feedback.other }
                    ];
                    
                    const hasContent = feedbackItems.some(item => item.content && item.content.trim());
                    
                    if (!hasContent) return '';
                    
                    return `
                        <div class="feedback-card">
                            <div class="feedback-card-header">
                                <div class="exec-avatar" style="background: ${color};">${initial}</div>
                                <div>
                                    <h4>${fb.exec_name}</h4>
                                    <div class="timestamp">Updated: ${timestamp}</div>
                                </div>
                            </div>
                            ${feedbackItems.filter(item => item.content && item.content.trim()).map(item => `
                                <div class="feedback-item">
                                    <div class="feedback-item-label">${item.label}</div>
                                    <div class="feedback-item-content">${escapeHtml(item.content)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }).filter(html => html).join('');
                
                if (!container.innerHTML.trim()) {
                    container.innerHTML = '<div class="no-feedback">No general feedback submitted yet.</div>';
                }
                
            } catch (error) {
                console.error('Error loading general feedback:', error);
                container.innerHTML = `<div class="no-feedback" style="color: var(--accent-danger);">Error loading general feedback: ${error.message}</div>`;
            }
        }
        
        // Decision data for reference
        const DECISIONS = [
            { id: 'growth-pod', title: 'Growth Pod with Roger as Lead', options: { 'yes-full': 'Yes - Full (Roger + 3)', 'yes-light': 'Yes - Light (Roger + 1)', 'no': 'No - Pods independent' }},
            { id: 'team-allocation', title: 'Team Allocation (31 FTEs)', options: { 'current': 'Keep current', 'acquisition-heavy': 'Shift 2 to Acquisition', 'retention-heavy': 'Shift 2 to Retention' }},
            { id: 'glp1-launch', title: 'GLP-1 Launch Date', options: { 'march1': 'March 1 (aggressive)', 'march15': 'March 15 (buffer)', 'april1': 'April 1 (safe)' }},
            { id: 'enterprise-allocation', title: 'Enterprise vs D2C Focus', options: { 'maintain': 'Maintain (5 FTEs)', 'increase': 'Increase to 7', 'decrease': 'Reduce to 3' }},
            { id: 'attach-rate', title: 'Add-on Attach Rate Target', options: { '30': '30% by Q3', '20': '20% by Q3', '15': '15% by Q3' }},
            { id: 'board-ask', title: 'Board Ask', options: { 'nothing': 'No ask - update only', 'runway': 'Request runway extension', 'strategic': 'Request strategic support' }},
            { id: 'headcount-changes', title: 'Headcount Changes', options: { 'maintain': 'Maintain (optimize roles)', 'moderate': 'Moderate (5-10 positions)', 'significant': 'Significant (10+)' }}
        ];
        
        async function loadDecisionInputs() {
            const container = document.getElementById('decisionSummaryGrid');
            const supabaseClient = window.annotationStore?.supabase;
            
            if (!supabaseClient || !window.annotationStore?.useSupabase) {
                container.innerHTML = '<div class="no-decisions">Decision inputs require Supabase connection.</div>';
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('decision_inputs')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-decisions">No decision inputs submitted yet.</div>';
                    return;
                }
                
                const execColors = {
                    'Sharam': '#60a5fa', 'Roger': '#34d399', 'Lindsay': '#fbbf24',
                    'Emma': '#f87171', 'Colin': '#a78bfa', 'Dan': '#ec4899'
                };
                
                // Aggregate decisions by decision type
                container.innerHTML = DECISIONS.map((decision, idx) => {
                    const votes = {};
                    const inputs = [];
                    
                    data.forEach(entry => {
                        const execDecision = entry.decisions?.[decision.id];
                        if (execDecision) {
                            if (execDecision.option) {
                                votes[execDecision.option] = (votes[execDecision.option] || 0) + 1;
                            }
                            if (execDecision.input && execDecision.input.trim()) {
                                inputs.push({ exec: entry.exec_name, text: execDecision.input, color: execColors[entry.exec_name] || '#60a5fa' });
                            }
                        }
                    });
                    
                    const maxVotes = Math.max(...Object.values(votes), 0);
                    
                    return `
                        <div class="decision-summary-card">
                            <div class="decision-summary-header">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div class="decision-number-badge">${idx + 1}</div>
                                    <h4>${decision.title}</h4>
                                </div>
                            </div>
                            <div class="vote-summary">
                                ${Object.entries(decision.options).map(([key, label]) => {
                                    const count = votes[key] || 0;
                                    const isLeading = count === maxVotes && count > 0;
                                    return `<div class="vote-option ${isLeading ? 'leading' : ''}">${label}<span class="count">${count}</span></div>`;
                                }).join('')}
                            </div>
                            <div class="decision-inputs-list">
                                ${inputs.length > 0 ? inputs.map(input => `
                                    <div class="decision-input-item">
                                        <div class="exec-name" style="color: ${input.color};">${input.exec}</div>
                                        <div class="input-text">${escapeHtml(input.text)}</div>
                                    </div>
                                `).join('') : '<div style="font-size: 12px; color: var(--text-muted);">No comments yet</div>'}
                            </div>
                        </div>
                    `;
                }).join('');
                
            } catch (error) {
                console.error('Error loading decision inputs:', error);
                container.innerHTML = `<div class="no-decisions" style="color: var(--accent-danger);">Error loading decision inputs: ${error.message}</div>`;
            }
        }
        
        async function loadTeamAssignments() {
            const container = document.getElementById('teamRosterSummary');
            const supabaseClient = window.annotationStore?.supabase;
            
            if (!supabaseClient || !window.annotationStore?.useSupabase) {
                container.innerHTML = '<div class="no-feedback">Team assignments require Supabase connection.</div>';
                return;
            }
            
            try {
                const { data, error } = await supabaseClient
                    .from('team_assignments')
                    .select('*')
                    .order('updated_at', { ascending: false });
                
                if (error && error.code !== '42P01') throw error; // 42P01 = table doesn't exist
                
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="no-feedback">No team assignments submitted yet. Executives can assign team members in Section 12.</div>';
                    return;
                }
                
                const execColors = {
                    'Sharam': '#60a5fa', 'Roger': '#34d399', 'Lindsay': '#fbbf24',
                    'Emma': '#f87171', 'Colin': '#a78bfa', 'Dan': '#ec4899'
                };
                
                // Build a consolidated view of all assignments
                const teamMembers = CONFIG.TEAM_ROSTER || [];
                const podAssignments = {};
                
                // Aggregate assignments by team member
                teamMembers.forEach(member => {
                    podAssignments[member.name] = {};
                    data.forEach(entry => {
                        const assignment = entry.assignments?.[member.name];
                        if (assignment && assignment.pod) {
                            podAssignments[member.name][entry.exec_name] = {
                                pod: assignment.pod,
                                notes: assignment.notes
                            };
                        }
                    });
                });
                
                // Create a grid view by pod
                const pods = ['Growth', 'Acquisition', 'Retention', 'Platform', 'Infrastructure', 'Enterprise', 'Ops/G&A'];
                
                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                        ${pods.map(pod => {
                            // Count how many execs assigned each person to this pod
                            const membersInPod = teamMembers.filter(member => {
                                const assignments = podAssignments[member.name];
                                const votes = Object.values(assignments).filter(a => a.pod === pod).length;
                                return votes > 0;
                            });
                            
                            return `
                                <div style="background: var(--bg-card); border-radius: 12px; padding: 16px; border: 1px solid var(--border-color);">
                                    <h4 style="margin-bottom: 12px; font-size: 14px; color: var(--accent-primary);">${pod} Pod</h4>
                                    ${membersInPod.length > 0 ? membersInPod.map(member => {
                                        const assignments = podAssignments[member.name];
                                        const voteCount = Object.values(assignments).filter(a => a.pod === pod).length;
                                        return `<div style="font-size: 12px; padding: 4px 0; color: var(--text-secondary);">${member.name} <span style="color: var(--text-muted);">(${voteCount})</span></div>`;
                                    }).join('') : '<div style="font-size: 12px; color: var(--text-muted);">No assignments yet</div>'}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
            } catch (error) {
                console.error('Error loading team assignments:', error);
                container.innerHTML = `<div class="no-feedback" style="color: var(--accent-danger);">Error loading team assignments: ${error.message}</div>`;
            }
        }
        
        function updateStats() {
            const stats = {
                total: allAnnotations.length,
                agree: 0,
                question: 0,
                concern: 0,
                idea: 0,
                bySection: {}
            };
            
            allAnnotations.forEach(a => {
                if (a.reaction_type) {
                    stats[a.reaction_type]++;
                }
                stats.bySection[a.section_id] = (stats.bySection[a.section_id] || 0) + 1;
            });
            
            document.getElementById('totalAnnotations').textContent = stats.total;
            document.getElementById('agreeCount').textContent = stats.agree;
            document.getElementById('questionCount').textContent = stats.question;
            document.getElementById('concernCount').textContent = stats.concern;
            document.getElementById('ideaCount').textContent = stats.idea;
            
            // Update section counts
            CONFIG.SECTIONS.forEach(section => {
                const countEl = document.getElementById(`count-${section.id}`);
                if (countEl) {
                    countEl.textContent = stats.bySection[section.id] || 0;
                }
            });
        }
        
        function updateExecBreakdown() {
            const breakdown = {};
            CONFIG.EXEC_NAMES.forEach(exec => {
                breakdown[exec] = 0;
            });
            
            allAnnotations.forEach(a => {
                if (breakdown[a.exec_name] !== undefined) {
                    breakdown[a.exec_name]++;
                }
            });
            
            const container = document.getElementById('execBreakdown');
            container.innerHTML = CONFIG.EXEC_NAMES.map(exec => {
                const count = breakdown[exec];
                const statusClass = count > 0 ? 'complete' : '';
                const statusText = count > 0 ? `${count} comments` : 'No comments yet';
                
                return `
                    <div class="exec-card">
                        <h4>${exec}</h4>
                        <div class="count">${count}</div>
                        <div class="status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderAnnotations() {
            let filtered = [...allAnnotations];
            
            // Filter by section
            if (currentSectionFilter !== 'all') {
                filtered = filtered.filter(a => a.section_id === currentSectionFilter);
            }
            
            // Filter by reaction
            if (currentReactionFilter !== 'all') {
                filtered = filtered.filter(a => a.reaction_type === currentReactionFilter);
            }
            
            // Sort by created_at descending
            filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            const container = document.getElementById('annotationList');
            
            if (filtered.length === 0) {
                container.innerHTML = '<div class="no-annotations">No annotations found</div>';
                return;
            }
            
            container.innerHTML = filtered.map(a => {
                const reactionInfo = CONFIG.REACTIONS[a.reaction_type] || { emoji: '', label: 'Comment' };
                const section = CONFIG.SECTIONS.find(s => s.id === a.section_id);
                const sectionName = section ? section.short : `Section ${a.section_id}`;
                const time = a.created_at ? new Date(a.created_at).toLocaleString() : '';
                const initial = a.exec_name ? a.exec_name[0].toUpperCase() : '?';
                
                return `
                    <div class="admin-annotation ${a.reaction_type || ''}">
                        <div class="annotation-header">
                            <div class="annotation-info">
                                <div class="exec-avatar">${initial}</div>
                                <div class="annotation-details">
                                    <h4>${a.exec_name}</h4>
                                    <div class="annotation-meta">${sectionName} ‚Ä¢ ${time}</div>
                                </div>
                            </div>
                            ${a.reaction_type ? `<span class="annotation-badge ${a.reaction_type}">${reactionInfo.emoji} ${reactionInfo.label}</span>` : ''}
                        </div>
                        ${a.comment_text ? `<div class="annotation-comment">${escapeHtml(a.comment_text)}</div>` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function setupEventListeners() {
            // Refresh button
            document.getElementById('refreshBtn').addEventListener('click', loadAllData);
            
            // Section tabs
            document.querySelectorAll('.section-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.section-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    currentSectionFilter = tab.dataset.section;
                    renderAnnotations();
                });
            });
            
            // Reaction filters
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentReactionFilter = btn.dataset.filter;
                    renderAnnotations();
                });
            });
            
            // Synthesize button
            document.getElementById('synthesizeBtn').addEventListener('click', generateAISummary);
        }
        
        async function generateAISummary() {
            const btn = document.getElementById('synthesizeBtn');
            const status = document.getElementById('aiStatus');
            const content = document.getElementById('aiContent');
            
            if (allAnnotations.length === 0) {
                showToast('No annotations to analyze');
                return;
            }
            
            // Use localStorage key (more secure than hardcoding in repo)
            let apiKey = localStorage.getItem('claude_api_key');
            
            if (!apiKey) {
                apiKey = prompt('Enter your Claude API key (sk-ant-...):\n\nThis will be stored securely in your browser.');
                if (!apiKey) {
                    showToast('API key required');
                    return;
                }
                localStorage.setItem('claude_api_key', apiKey);
            }
            
            btn.disabled = true;
            btn.textContent = 'üîÑ Generating...';
            status.textContent = 'Analyzing feedback with AI...';
            content.innerHTML = '<div class="loading"><div class="spinner"></div>Generating summary...</div>';
            
            try {
                // Prepare the prompt
                const annotationsBySection = {};
                CONFIG.SECTIONS.forEach(s => {
                    annotationsBySection[s.title] = allAnnotations
                        .filter(a => a.section_id === s.id)
                        .map(a => ({
                            exec: a.exec_name,
                            reaction: a.reaction_type,
                            comment: a.comment_text
                        }));
                });
                
                // Also fetch general feedback
                let generalFeedbackText = '';
                const supabaseForAI = window.annotationStore?.supabase;
                if (supabaseForAI && window.annotationStore?.useSupabase) {
                try {
                    const { data: generalData } = await supabaseForAI
                        .from('general_feedback')
                        .select('*');
                    
                    if (generalData && generalData.length > 0) {
                        generalFeedbackText = `\n\n## General Strategic Feedback\n\n` + generalData.map(fb => {
                            const feedback = fb.feedback || {};
                            let text = `### ${fb.exec_name}\n`;
                            if (feedback.priorities) text += `**Top Priorities:** ${feedback.priorities}\n`;
                            if (feedback.risks) text += `**Risks/Concerns:** ${feedback.risks}\n`;
                            if (feedback.ideas) text += `**Ideas:** ${feedback.ideas}\n`;
                            if (feedback.questions) text += `**Questions:** ${feedback.questions}\n`;
                            if (feedback.other) text += `**Other:** ${feedback.other}\n`;
                            return text;
                        }).join('\n');
                    }
                } catch (e) {
                    console.error('Error fetching general feedback for AI:', e);
                }
                } // End of supabaseForAI check
                
                const prompt = `You are helping prepare for an executive offsite meeting at Signos. Analyze the following pre-read feedback from executives and provide a structured summary.

## Executive Feedback by Section

${Object.entries(annotationsBySection).map(([section, annotations]) => {
    if (annotations.length === 0) return `### ${section}\nNo feedback yet.`;
    return `### ${section}
${annotations.map(a => `- **${a.exec}** (${a.reaction || 'comment'}): ${a.comment || '[reaction only]'}`).join('\n')}`;
}).join('\n\n')}
${generalFeedbackText}

## Your Task

Provide a comprehensive analysis with these sections:

---

## 1. Executive Summary Narrative
Write a 2-3 paragraph narrative summary of the overall feedback from all executives. What is the collective sentiment? What are they most aligned on? Where do they diverge? This should read like a brief to prepare someone for the offsite.

---

## 2. Feedback by Executive
For each executive who provided feedback, create a summary:

### [Executive Name]
- **Overall Stance:** (supportive/cautious/concerned/etc.)
- **Key Points:** Bullet their main feedback points
- **Priorities:** What they emphasized most
- **Concerns:** Any worries or questions they raised

---

## 3. Feedback by Section
For each section of the pre-read, summarize the collective feedback:

### Section [#]: [Title]
- **Consensus:** What most executives agreed on
- **Divergence:** Where opinions differed
- **Key Questions:** Questions raised about this section
- **Recommendations:** Any suggestions made

---

## 4. Strategic Synthesis

### Areas of Strong Consensus
List specific items where executives are aligned

### Areas Requiring Discussion
List items where there's disagreement or uncertainty

### Open Questions for Offsite
Questions that need to be resolved during the Monday/Tuesday sessions

### Board Meeting Implications
How this feedback should inform the Wednesday board presentation

---

Be specific, cite which executives said what, and keep the tone professional and actionable.`;

                // Call Claude API
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01',
                        'anthropic-dangerous-direct-browser-access': 'true'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 8000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });
                
                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status}`);
                }
                
                const data = await response.json();
                const summary = data.content[0].text;
                
                // Convert markdown to HTML (simple conversion)
                const htmlSummary = markdownToHtml(summary);
                
                content.innerHTML = `<div class="ai-result">${htmlSummary}</div>`;
                status.textContent = `Generated at ${new Date().toLocaleTimeString()}`;
                
            } catch (error) {
                console.error('AI Summary error:', error);
                // If auth error, clear the stored key so user can try again
                if (error.message.includes('401')) {
                    localStorage.removeItem('claude_api_key');
                }
                content.innerHTML = `<div class="ai-placeholder" style="color: var(--accent-danger);">
                    <p>Error generating summary: ${error.message}</p>
                    <p style="font-size: 12px; margin-top: 8px;">Click "Generate AI Summary" again to enter a new API key.</p>
                </div>`;
                status.textContent = 'Error - click to retry with new key';
            }
            
            btn.disabled = false;
            btn.textContent = 'ü§ñ Generate AI Summary';
        }
        
        // Simple markdown to HTML converter
        function markdownToHtml(md) {
            return md
                .replace(/^### (.*$)/gim, '<h4>$1</h4>')
                .replace(/^## (.*$)/gim, '<h3>$1</h3>')
                .replace(/^# (.*$)/gim, '<h3>$1</h3>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
    </script>
</body>
</html>
